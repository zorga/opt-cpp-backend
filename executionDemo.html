<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Access-Control-Allow-Origin" content="*"/>
</head>
<body>

<h1>Execution steps browser</h1>

<!-- Include the required files for CodeMirror (codemirror.net) -->
<script src="/home/nico/coding/CodeMirror/lib/codemirror.js"></script>
<link rel="stylesheet" href="/home/nico/coding/CodeMirror/lib/codemirror.css">
<script src="/home/nico/coding/CodeMirror/mode/javascript/javascript.js"></script>
<script src="/home/nico/coding/CodeMirror/mode/clike/clike.js"></script>

<!-- Since the CSS is small, directly put it in the html file -->
<!-- The following style code is for highlight the current line of the execution -->
<style>
  .current_line {
    background: #00cc00;
  }
  .default {
    background: #ffffff;
    color: #ffffff;
  }
  img {
    max-width: 70%;
    max-height: 70%;
  }
  #codeEditor {
    max-width: 100%;
    max-height: 100%;
  }
</style>
<!-- end of CSS -->

<!-- Beginning page design -->
<div id="container" style="width:100%;">
  <div id="left" style="float:left; width:50%;">
    <div id="codeEditor"></div>
    <div id="buttonsPanel">
      <center id="c">
        <button onclick="initLoop()">Reset Execution</button>
        <button onclick="steps(false)">Previous step</button>
        <button onclick="steps(true);">Next step</button>
        <p id="progression">Current Execution Point : </p>
      </center>
    </div>
  </div>
  <div id="right" style="float:right; width:50%;">
    <center>
      <div id="ExecImages"></div>
    </center>
  </div>
<div>

<!-- Get and parse the trace file from the web server inside the INGI network -->
<script type="text/javascript"> 

/*
* Download the trace file from the server and parse it
* Then display the source-code (in the trace file) using the
* 'handleJsonObject' function with 'displaySourceCode' function
*/
function loadTraceFile(callback) {
  var xobj = new XMLHttpRequest();
  xobj.overrideMimeType("application/json");
  xobj.open("GET", "http://localhost/thesis_LinkedList.trace", true);
  xobj.onreadystatechange = function() {
    if (xobj.readyState == 4 && xobj.status == "200") {
      callback(xobj.responseText);
    }
  };
  xobj.send();
}

/*
* get the exec point image corresponding to a specific execution point
* 'currExecPointObject' is the currently processed exec point in the trace file
* This function dislays the exec point image and highlight the corresponding line
* in the code
*/
function getExecPointImage (currExecPointObject, i) {
  var server = "http://localhost";
  var prefix = "/img/exec_point_";
  var indice = i.toString();
  var ext = ".svg";
  var filename = server + prefix + indice + ext;
  curr_line_number = currExecPointObject.line;
  image = document.createElement("img");
  image.setAttribute("src", filename);
  image.setAttribute("id", "curr_exec_image");
  document.getElementById("ExecImages").appendChild(image);
  // Highlight the current line in CodeMirror element
  //var codeMirror = this.codeMirror;
  //console.log("Highlight line number : " + curr_line_number);
  //codeMirror.addLineClass(curr_line_number, 'background', 'current_line');
}

/*
* Removes the image currently displayed on the page
* (If there is one)
*/
function clear() {
  // delete the displayed image :
  var imageZone = document.getElementById("ExecImages"); 
  var image = document.getElementById("curr_exec_image");
  if (image)
    imageZone.removeChild(image);
}

/*
* 'source' is the string representing the source code of the C program
*/
function displaySourceCode(source) {
  // this display the source code in a beautiful CodeMirror element
  var myCodeMirror = CodeMirror(document.getElementById("codeEditor"), {
    value: source,
    mode: "text/x-c",
    readOnly: true,
    lineNumbers: true
  }); 
  // Put the codeMirror in the object to easy get it elsewhere in the code
  this.codeMirror = myCodeMirror;
}

/*
* initialization of the execution loop
*/
function initLoop() {
  clear();
  var codeMirror = this.codeMirror;
  // "un-highlight" the previous highlighted line :
  if (this.previousLine)
  {
    console.log("initLoop ok : " + this.previousLine);
    codeMirror.addLineClass(this.previousLine - 1, 'background', 'default');
  }

  getExecPointImage(this.ExecPoints[0], 0);
  // Put the needed info into object to get them in the next steps :
  this.currExecPointNumber = 0;
  displayProgression();
  curr_line = this.ExecPoints[0].line;
  console.log("initLoop : curr_line : " + curr_line);
  // decrement the line number because the lines begin at '0' in CodeMirror API :
  codeMirror.addLineClass(curr_line - 1, 'background', 'current_line');
  // saving the previous line to unhighlight it next steps : 
  this.previousLine = curr_line;
  console.log(this.previousLine);
}

/*
* display the current execution point number under the codeMirror object
*/
function displayProgression() {
  total = this.ExecPoints.length - 1;
  current = this.currExecPointNumber;
  var toDisplay = "Current Execution Point : " + current.toString() + "/" + total.toString();
  var progression = document.getElementById("progression");
  var text = document.createElement("p");
  text.textContent = toDisplay;
  text.setAttribute("id", "progression");
  progression.parentNode.replaceChild(text, progression);
}

/*
* for the 'Next Step' and 'Previous step' buttons
*/
function steps(isNext) {
  var codeMirror = this.codeMirror;
  total = this.ExecPoints.length;
  var curr_i = this.currExecPointNumber; 
  var ExecutionPoints = this.ExecPoints;
  var currExecPointObject = ExecutionPoints[curr_i];
  var curr_line = currExecPointObject.line;
  if (this.previousLine)
  {
    if (this.previousLine == curr_line)
    {
      console.log("coucou");
    }
    else
    {
      console.log("steps ok : " + this.previousLine);
      codeMirror.addLineClass(this.previousLine - 1, 'background', 'default');
    }
  }
  // clear the page to remove previous exec point data :
  clear();
  // check which button has been pressed and perform the right operation :
  if (isNext && curr_i < total - 1)
  {
    curr_i++;
  }
  else if (!isNext && curr_i > 0)
  {
    curr_i--;
  }
  // Highlight the current line :
  codeMirror.addLineClass(curr_line - 1, 'background', 'current_line');
  // Saving previous line :
  this.previousLine = curr_line;
  // display the right exec point image :
  getExecPointImage(currExecPointObject, curr_i);
  this.currExecPointNumber = curr_i;
  displayProgression();
}

/*
* get the response from the HTTP request and parse the trace (json) file into
* a JS object
* Then we can do whatever whe want with that object beginning by displaying the
* code on the html page
*/
function handleJsonObject() {
  loadTraceFile(function(response) {
    // parse JSON string into object
    var json_object = JSON.parse(response);
    // displaying the source-code by passing the 'code' entry of the trace file
    displaySourceCode(json_object.code);
    // starting execution loop :
    this.ExecPoints = (json_object.trace);
    initLoop();
  });
}

// Calling the 'main' function to start everything !
handleJsonObject();
 

</script>

</body>
</html>
